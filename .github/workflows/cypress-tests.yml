name: Cypress E2E Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch: # Allow manual triggering

jobs:
  cypress-run:
    name: Cypress Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      # ===================================================================
      # SERVICE SETUP (REQUIRED FOR E2E TESTS)
      # ===================================================================
      # You need to start Frontend and Backend before running Cypress tests.
      # Choose ONE of the following options:
      #
      # OPTION A: Checkout QBrain repository and start services
      # Uncomment the following if QBrain repo is separate:
      # - name: Checkout QBrain repository
      #   uses: actions/checkout@v4
      #   with:
      #     repository: your-org/QBrain  # Update with your repo path
      #     path: qbrain-repo
      #
      # OPTION B: Services are in parent directory (if repos are in same workspace)
      # - name: Start Backend API
      #   run: |
      #     cd ../QBrain/backend
      #     npm ci
      #     npm run dev &
      #   env:
      #     NODE_ENV: test
      #
      # - name: Start Frontend
      #   run: |
      #     cd ../QBrain/frontend
      #     npm ci
      #     npm run dev &
      #   env:
      #     VITE_API_BASE_URL: http://localhost:5000/api
      #
      # OPTION C: Use Docker Compose (if available)
      # - name: Start services with Docker Compose
      #   run: docker-compose up -d
      #
      # OPTION D: Test against deployed staging environment
      # Update baseUrl in cypress.config.js or set CYPRESS_BASE_URL env var
      # ===================================================================

      # Wait for services to be ready (uncomment if services are started above)
      # - name: Wait for services
      #   run: |
      #     timeout 120 bash -c 'until curl -f http://localhost:8080 > /dev/null 2>&1; do sleep 2; done'
      #     timeout 120 bash -c 'until curl -f http://localhost:5000/api/health > /dev/null 2>&1; do sleep 2; done'

      - name: Run Cypress tests
        uses: cypress-io/github-action@v6
        with:
          install: false # Already installed dependencies
          browser: chrome
          spec: 'cypress/e2e/features/**/*.feature'
          record: false # Set to true and add CYPRESS_RECORD_KEY if using Cypress Dashboard
          # record-key: ${{ secrets.CYPRESS_RECORD_KEY }}
          # project-id: your-project-id
          # IMPORTANT: Configure one of the following:
          # Option 1: If services are started in steps above, uncomment to wait for them:
          # wait-on: 'http://localhost:8080'
          # wait-on-timeout: 120
          #
          # Option 2: If testing against remote/staging environment, keep start: false
          # and set CYPRESS_BASE_URL environment variable (see comment below)
          start: false
        # To add environment variables, uncomment the 'env:' block below and add your variables:
        # env:
        #   # For local services: baseUrl from cypress.config.js will be used (http://localhost:8080)
        #   # For remote/staging: Uncomment and set your staging URL:
        #   CYPRESS_BASE_URL: ${{ secrets.CYPRESS_BASE_URL || 'https://your-staging-url.com' }}
        #   CYPRESS_API_URL: ${{ secrets.CYPRESS_API_URL || 'https://api.your-staging-url.com/api' }}

      - name: Upload Cypress screenshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: cypress-screenshots
          path: cypress/screenshots
          retention-days: 7

      - name: Upload Cypress videos
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cypress-videos
          path: cypress/videos
          retention-days: 7

      - name: Upload Cucumber JSON reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cucumber-json-reports
          path: cypress/cucumber-json
          retention-days: 30

      - name: Test Summary
        if: always()
        run: |
          echo "## Cypress Test Results" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Tests completed" >> $GITHUB_STEP_SUMMARY
          if [ -d "cypress/cucumber-json" ]; then
            echo "ðŸ“Š Cucumber reports generated in cypress/cucumber-json/" >> $GITHUB_STEP_SUMMARY
          fi

  # Optional: Run tests on multiple browsers
  # cypress-run-matrix:
  #   name: Cypress Tests (${{ matrix.browser }})
  #   runs-on: ubuntu-latest
  #   strategy:
  #     fail-fast: false
  #     matrix:
  #       browser: [chrome, firefox, edge]
  #   timeout-minutes: 30
  #
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: '18'
  #         cache: 'npm'
  #         cache-dependency-path: package-lock.json
  #
  #     - name: Install dependencies
  #       run: npm ci
  #
  #     - name: Run Cypress tests
  #       uses: cypress-io/github-action@v6
  #       with:
  #         install: false
  #         browser: ${{ matrix.browser }}
  #         headless: true
  #         spec: 'cypress/e2e/features/**/*.feature'
  #
  #     - name: Upload Cypress videos
  #       uses: actions/upload-artifact@v4
  #       if: always()
  #       with:
  #         name: cypress-videos-${{ matrix.browser }}
  #         path: cypress/videos
  #         retention-days: 7
